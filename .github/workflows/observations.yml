name: Observations Daily

on:
  schedule:
    - cron: '0 5 * * *'  # ~07:00 Europe/Paris en été (UTC+2)
    - cron: '0 6 * * *'  # ~07:00 Europe/Paris en hiver (UTC+1)
  workflow_dispatch:
    inputs:
      days_back:
        description: "J-X (1 par défaut) pour lancer manuellement J-10, J-6, etc."
        required: false
        default: "1"

permissions:
  id-token: write
  contents: read

jobs:
  fetch-observations:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      MF_BASIC_AUTH_B64: ${{ secrets.MF_BASIC_AUTH_B64 }}
      METEO_TOKEN_CACHE: ${{ github.workspace }}/.cache/mf_token.json
      METEO_MAX_RPM: '50'
    steps:
      - uses: actions/checkout@v4

      - name: Gate by local time Europe/Paris
        if: ${{ github.event_name == 'schedule' }}
        run: .github/scripts/should_run.sh daily-07:00

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps with uv
        run: |
          uv pip install requests python-dateutil boto3 --system

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Compute target date
        id: date
        shell: bash
        run: |
          DBACK="${{ github.event.inputs.days_back }}"
          [ -z "$DBACK" ] && DBACK="1"
          echo "YMD=$(date -u -d "$DBACK days ago" +%F)" >> $GITHUB_OUTPUT

      - name: Fetch J-X → DynamoDB (pipe)
        run: |
          python -m src.download.fetch_observations \
            --date "${{ steps.date.outputs.YMD }}" \
            --stations data/metadonnees/stations.json \
            --logdir logs/observations \
          | python -m src.upload.stdin_to_dynamodb \
              --table Observations --pk id --sk date

      - name: Cleanup missing registry (keep 11 days)
        run: |
          python -m src.utils.cleanup_missing_observations --days 11

      - name: Retry missing → DynamoDB (pipe)
        run: |
          python -m src.download.fetch_missing_observations \
            --missing data/metadonnees/missing_observations.json \
            --stations data/metadonnees/stations.json \
            --logdir logs/observations \
          | python -m src.upload.stdin_to_dynamodb \
              --table Observations --pk id --sk date
