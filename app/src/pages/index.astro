---
import '../styles/global.css';
import SnowMap from '../components/SnowMap.astro';

const base = import.meta.env.BASE_URL; // '/niveo/' en prod, '/' en dev
const obsUrl = `${base}data/observations.json`;
const staUrl = `${base}data/metadonnees/stations.json`;
---
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nivéo — Visualisation neigeuse</title>
    <meta name="color-scheme" content="dark light" />
  </head>
  <body data-obs-url={obsUrl}>
    <header class="container page-header flex items-center gap-3">
      <h1 class="sr-only">Nivéo - Application de visualisation de la hauteur de neige</h1>
        <a href={base}>
          <img
            src={`${base}logo/niveo-dark.svg`}
            alt="Nivéo"
            loading="eager"
            decoding="async"
          />
        </a>
    </header>
    
    <main class="page-main">
      <section class="card flex flex-col">
        <h2 class="sr-only">Visualisation neigeuse</h2>
        <div class="layout">
          <SnowMap obsUrl={obsUrl} staUrl={staUrl} />
        </div>
      </section>
    </main>

    <footer class="site-footer" role="contentinfo" aria-label="Pied de page et citation des données">
      <div class="container">
        <p class="meta">
          Mis à jour le<time id="last-update" datetime=""></time>
          <span aria-hidden="true">•</span>
          <a href="https://public-api.meteofrance.fr/public/DPClim/v1" rel="noopener noreferrer">API DPClim v1</a>
        </p>
      </div>
    </footer>


    <script type="module">
      // Utilise l'URL déjà posée sur #map
      const obsUrl =
        document.querySelector('#map')?.dataset?.obs ||
        document.body.dataset?.obsUrl || '';

      // Format "YYYY-MM-DD" -> "JJ/MM/AAAA" sans objet Date +1j (enregistrement J correspond à J+1 à 6h)
      const fmtFR = (iso) => {
        if (!iso) return '';
        const d = new Date(iso);
        // travaille en UTC pour éviter le fuseau
        d.setUTCDate(d.getUTCDate() + 1);
        const dd = String(d.getUTCDate()).padStart(2, '0');
        const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
        const yy = d.getUTCFullYear();
        return `${dd}/${mm}/${yy}`;
      };

      (async () => {
        if (!obsUrl) return;

        const data = await fetch(obsUrl).then(r => r.json()).catch(() => null);
        if (!Array.isArray(data) || data.length === 0) return;

        const lastISO = Array.from(new Set(
          data.map(d => d && d.date).filter(Boolean)
        )).sort().at(-1);
        if (!lastISO) return;

        const t = document.getElementById('last-update');
        if (t) {
          t.textContent = fmtFR(lastISO);
          t.setAttribute('datetime', lastISO);
        }
      })();
    </script>


  </body>
</html>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2YTSV4PT9X"></script>
<script is:inline>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-2YTSV4PT9X', { 'anonymize_ip': true });
</script>